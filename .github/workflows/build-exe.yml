name: Build SurfSync EXE

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-exe:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore SurfSync.sln

      - name: Prepare build version
        id: build_version
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $utcDate = (Get-Date).ToUniversalTime().Date
          $datePart = "{0}.{1}.{2}" -f $utcDate.Year, $utcDate.Month, $utcDate.Day
          $dayStart = $utcDate.ToString("yyyy-MM-ddT00:00:00Z")
          $dayEnd = $utcDate.AddDays(1).AddSeconds(-1).ToString("yyyy-MM-ddTHH:mm:ssZ")
          $createdRange = "$dayStart..$dayEnd"
          $createdEncoded = [System.Uri]::EscapeDataString($createdRange)
          $uri = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-exe.yml/runs?branch=main&per_page=100&created=$createdEncoded"

          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            "X-GitHub-Api-Version" = "2022-11-28"
            Accept = "application/vnd.github+json"
            "User-Agent" = "surfsync-build-workflow"
          }

          $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get
          $currentRunNumber = [int]${{ github.run_number }}
          $buildNumberToday = @(
            $response.workflow_runs | Where-Object { [int]$_.run_number -le $currentRunNumber }
          ).Count

          if ($buildNumberToday -lt 1) {
            $buildNumberToday = 1
          }

          $version = "$datePart.$buildNumberToday"
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Publish single-file executable
        run: dotnet publish SurfSync/SurfSync.csproj -c Release -r win-x64 --self-contained true -o artifacts/SurfSync-win-x64 /p:Version=${{ steps.build_version.outputs.version }} /p:AssemblyVersion=${{ steps.build_version.outputs.version }} /p:FileVersion=${{ steps.build_version.outputs.version }}

      - name: Verify EXE exists
        shell: pwsh
        run: |
          if (-not (Test-Path "artifacts/SurfSync-win-x64/SurfSync.exe")) {
            throw "SurfSync.exe was not generated."
          }

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: SurfSync-win-x64-exe-${{ steps.build_version.outputs.version }}
          path: artifacts/SurfSync-win-x64/SurfSync.exe
          if-no-files-found: error

      - name: Prepare release metadata
        id: release_meta
        shell: pwsh
        run: |
          $version = "${{ steps.build_version.outputs.version }}"
          $tag = "v$version"
          $name = "SurfSync $version"
          "tag=$tag" >> $env:GITHUB_OUTPUT
          "name=$name" >> $env:GITHUB_OUTPUT

      - name: Publish EXE to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          prerelease: true
          generate_release_notes: true
          files: artifacts/SurfSync-win-x64/SurfSync.exe
